cd /home/pd2669/data-engineering-zoomcamp-gcp/02-workflow-orchestration
docker-compose up


gcloud auth login
gcloud compute instances describe de-zoomcamp


SELECT * FROM `big-bliss-411815.demo_dataset.your_table2` LIMIT 1000
INSERT `big-bliss-411815.demo_dataset.your_table2` (column1)
VALUES ('Your exemplary value 1'),
       ('Your exemplary value 2'),
       ('Your exemplary value 3')
;


 gcloud auth list
                      Credentialed Accounts
ACTIVE  ACCOUNT
        103043800958-compute@developer.gserviceaccount.com
*       pd2669@pjwstk.edu.pl
        terraform-runner@big-bliss-411815.iam.gserviceaccount.com

To set the active account, run:
    $ gcloud config set account `ACCOUNT`


chestration$ gcloud storage ls
gs://big-bliss-411815-terra-bucket/
gs://mage-zoomcamp-pd2669/


(pd2669) pd2669@de-zoomcamp:~/data-engineering-zoomcamp-gcp/02-workflow-orchestration$ gcloud config set account pd2669@pjwstk.edu.pl
Updated property [core/account].
(pd2669) pd2669@de-zoomcamp:~/data-engineering-zoomcamp-gcp/02-workflow-orchestration$ gcloud storage ls
gs://big-bliss-411815-terra-bucket/
gs://mage-zoomcamp-pd2669/

git clone https://github.com/mage-ai/mage-ai-terraform-templates.git


### terraform
cd /home/pd2669/data-engineering-zoomcamp-gcp/02-workflow-orchestration/mage-terraform/mage-ai-terraform-templates/gcp
terraform init
terraform plan
terraform apply
pass: postgress
terraform destroy


gcloud sql instances delete mage-data-prep-db-instance
All of the instance data will be lost when the instance is deleted.

Do you want to continue (Y/n)?  Y

Deleting Cloud SQL instance...done.                                                                                        
Deleted [https://sqladmin.googleapis.com/sql/v1beta4/projects/big-bliss-411815/instances/mage-data-prep-db-instance].




(pd2669) pd2669@de-zoomcamp:~/data-engineering-zoomcamp-gcp/02-workflow-orchestration/mage-terraform/mage-ai-terraform-templates/gcp$ terraform apply
var.database_password
  The password of the Postgres database.

  Enter a value: 


Terraform used the selected providers to generate the
following execution plan. Resource actions are indicated with
the following symbols:
  + create

Terraform will perform the following actions:

  # google_cloud_run_service.run_service will be created
  + resource "google_cloud_run_service" "run_service" {
      + autogenerate_revision_name = true
      + id                         = (known after apply)
      + location                   = "us-central1"
      + name                       = "mage-data-prep"
      + project                    = "big-bliss-411815"
      + status                     = (known after apply)

      + metadata {
          + annotations           = {
              + "run.googleapis.com/ingress"      = "internal-and-cloud-load-balancing"
              + "run.googleapis.com/launch-stage" = "BETA"
            }
          + effective_annotations = {
              + "run.googleapis.com/ingress"      = "internal-and-cloud-load-balancing"
              + "run.googleapis.com/launch-stage" = "BETA"
            }
          + effective_labels      = (known after apply)
          + generation            = 0
          + namespace             = (known after apply)
          + resource_version      = (known after apply)
          + self_link             = (known after apply)
          + terraform_labels      = (known after apply)
          + uid                   = (known after apply)
        }

      + template {
          + metadata {
              + annotations      = (known after apply)
              + generation       = (known after apply)
              + labels           = (known after apply)
              + name             = (known after apply)
              + namespace        = (known after apply)
              + resource_version = (known after apply)
              + self_link        = (known after apply)
              + uid              = (known after apply)
            }
          + spec {
              + container_concurrency = (known after apply)
              + service_account_name  = (known after apply)
              + serving_state         = (known after apply)
              + timeout_seconds       = (known after apply)

              + containers {
                  + image = "mageai/mageai:latest"
                  + name  = (known after apply)

                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }
                  + env {
                      # At least one attribute in this block is (or was) sensitive,
                      # so its contents will not be displayed.
                    }

                  + ports {
                      + container_port = 6789
                      + name           = (known after apply)
                    }

                  + resources {
                      + limits = {
                          + "cpu"    = "2000m"
                          + "memory" = "2G"
                        }
                    }
                }
            }
        }

      + traffic {
          + latest_revision = true
          + percent         = 100
          + url             = (known after apply)
        }
    }

  # google_cloud_run_service_iam_member.run_all_users will be created
  + resource "google_cloud_run_service_iam_member" "run_all_users" {
      + etag     = (known after apply)
      + id       = (known after apply)
      + location = "us-central1"
      + member   = "allUsers"
      + project  = (known after apply)
      + role     = "roles/run.invoker"
      + service  = "mage-data-prep"
    }

  # google_filestore_instance.instance will be created
  + resource "google_filestore_instance" "instance" {
      + create_time      = (known after apply)
      + effective_labels = (known after apply)
      + etag             = (known after apply)
      + id               = (known after apply)
      + location         = "us-central1-b"
      + name             = "mage-data-prep"
      + project          = "big-bliss-411815"
      + terraform_labels = (known after apply)
      + tier             = "BASIC_HDD"
      + zone             = (known after apply)

      + file_shares {
          + capacity_gb   = 1024
          + name          = "share1"
          + source_backup = (known after apply)
        }

      + networks {
          + connect_mode      = "DIRECT_PEERING"
          + ip_addresses      = (known after apply)
          + modes             = [
              + "MODE_IPV4",
            ]
          + network           = "default"
          + reserved_ip_range = (known after apply)
        }
    }

  # google_project_service.artifactregistry will be created
  + resource "google_project_service" "artifactregistry" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "artifactregistry.googleapis.com"
    }

  # google_project_service.cloudrun will be created
  + resource "google_project_service" "cloudrun" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "run.googleapis.com"
    }

  # google_project_service.iam will be created
  + resource "google_project_service" "iam" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "iam.googleapis.com"
    }

  # google_project_service.resourcemanager will be created
  + resource "google_project_service" "resourcemanager" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "cloudresourcemanager.googleapis.com"
    }

  # google_project_service.secretmanager will be created
  + resource "google_project_service" "secretmanager" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "secretmanager.googleapis.com"
    }

  # google_project_service.sqladmin will be created
  + resource "google_project_service" "sqladmin" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "sqladmin.googleapis.com"
    }

  # google_project_service.vpcaccess will be created
  + resource "google_project_service" "vpcaccess" {
      + disable_on_destroy = false
      + id                 = (known after apply)
      + project            = "big-bliss-411815"
      + service            = "vpcaccess.googleapis.com"
    }

  # google_sql_database.database will be created
  + resource "google_sql_database" "database" {
      + charset         = (known after apply)
      + collation       = (known after apply)
      + deletion_policy = "DELETE"
      + id              = (known after apply)
      + instance        = "mage-data-prep-db-instance"
      + name            = "mage-data-prep-db"
      + project         = "big-bliss-411815"
      + self_link       = (known after apply)
    }

  # google_sql_database_instance.instance will be created
  + resource "google_sql_database_instance" "instance" {
      + available_maintenance_versions = (known after apply)
      + connection_name                = (known after apply)
      + database_version               = "POSTGRES_14"
      + deletion_protection            = false
      + dns_name                       = (known after apply)
      + encryption_key_name            = (known after apply)
      + first_ip_address               = (known after apply)
      + id                             = (known after apply)
      + instance_type                  = (known after apply)
      + ip_address                     = (known after apply)
      + maintenance_version            = (known after apply)
      + master_instance_name           = (known after apply)
      + name                           = "mage-data-prep-db-instance"
      + private_ip_address             = (known after apply)
      + project                        = "big-bliss-411815"
      + psc_service_attachment_link    = (known after apply)
      + public_ip_address              = (known after apply)
      + region                         = "us-central1"
      + self_link                      = (known after apply)
      + server_ca_cert                 = (sensitive value)
      + service_account_email_address  = (known after apply)

      + settings {
          + activation_policy     = "ALWAYS"
          + availability_type     = "ZONAL"
          + connector_enforcement = (known after apply)
          + disk_autoresize       = true
          + disk_autoresize_limit = 0
          + disk_size             = (known after apply)
          + disk_type             = "PD_SSD"
          + edition               = "ENTERPRISE"
          + pricing_plan          = "PER_USE"
          + tier                  = "db-f1-micro"
          + user_labels           = (known after apply)
          + version               = (known after apply)

          + database_flags {
              + name  = "max_connections"
              + value = "50"
            }
        }
    }

  # google_sql_user.database-user will be created
  + resource "google_sql_user" "database-user" {
      + host                    = (known after apply)
      + id                      = (known after apply)
      + instance                = "mage-data-prep-db-instance"
      + name                    = "postgres"
      + password                = (sensitive value)
      + project                 = "big-bliss-411815"
      + sql_server_user_details = (known after apply)
    }

  # google_vpc_access_connector.connector will be created
  + resource "google_vpc_access_connector" "connector" {
      + connected_projects = (known after apply)
      + id                 = (known after apply)
      + ip_cidr_range      = "10.8.0.0/28"
      + machine_type       = "e2-micro"
      + max_instances      = (known after apply)
      + max_throughput     = 300
      + min_instances      = (known after apply)
      + min_throughput     = 200
      + name               = "mage-data-prep-connector"
      + network            = "default"
      + project            = "big-bliss-411815"
      + region             = "us-central1"
      + self_link          = (known after apply)
      + state              = (known after apply)
    }

Plan: 14 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

google_project_service.cloudrun: Creating...
google_project_service.secretmanager: Creating...
google_filestore_instance.instance: Creating...
google_vpc_access_connector.connector: Creating...
google_project_service.iam: Creating...
google_project_service.artifactregistry: Creating...
google_project_service.resourcemanager: Creating...
google_project_service.sqladmin: Creating...
google_project_service.vpcaccess: Creating...
google_sql_database_instance.instance: Creating...
google_project_service.secretmanager: Creation complete after 4s [id=big-bliss-411815/secretmanager.googleapis.com]
google_project_service.resourcemanager: Creation complete after 4s [id=big-bliss-411815/cloudresourcemanager.googleapis.com]
google_project_service.artifactregistry: Creation complete after 4s [id=big-bliss-411815/artifactregistry.googleapis.com]
google_project_service.sqladmin: Creation complete after 4s [id=big-bliss-411815/sqladmin.googleapis.com]
google_project_service.cloudrun: Creation complete after 4s [id=big-bliss-411815/run.googleapis.com]
google_project_service.iam: Creation complete after 4s [id=big-bliss-411815/iam.googleapis.com]
google_project_service.vpcaccess: Creation complete after 4s [id=big-bliss-411815/vpcaccess.googleapis.com]
google_filestore_instance.instance: Still creating... [10s elapsed]
google_vpc_access_connector.connector: Still creating... [10s elapsed]
google_sql_database_instance.instance: Still creating... [10s elapsed]
google_filestore_instance.instance: Still creating... [20s elapsed]
google_vpc_access_connector.connector: Still creating... [20s elapsed]
google_sql_database_instance.instance: Still creating... [20s elapsed]
google_filestore_instance.instance: Still creating... [30s elapsed]
google_vpc_access_connector.connector: Still creating... [30s elapsed]
google_sql_database_instance.instance: Still creating... [30s elapsed]
google_filestore_instance.instance: Still creating... [40s elapsed]
google_vpc_access_connector.connector: Still creating... [40s elapsed]
google_sql_database_instance.instance: Still creating... [40s elapsed]
google_filestore_instance.instance: Still creating... [50s elapsed]
google_vpc_access_connector.connector: Still creating... [50s elapsed]
google_sql_database_instance.instance: Still creating... [50s elapsed]
google_filestore_instance.instance: Still creating... [1m0s elapsed]
google_vpc_access_connector.connector: Still creating... [1m0s elapsed]
google_sql_database_instance.instance: Still creating... [1m0s elapsed]
google_filestore_instance.instance: Still creating... [1m10s elapsed]
google_vpc_access_connector.connector: Still creating... [1m10s elapsed]
google_sql_database_instance.instance: Still creating... [1m10s elapsed]
google_filestore_instance.instance: Still creating... [1m20s elapsed]
google_vpc_access_connector.connector: Still creating... [1m20s elapsed]
google_sql_database_instance.instance: Still creating... [1m20s elapsed]
google_vpc_access_connector.connector: Still creating... [1m30s elapsed]
google_filestore_instance.instance: Still creating... [1m30s elapsed]
google_sql_database_instance.instance: Still creating... [1m30s elapsed]
google_filestore_instance.instance: Still creating... [1m40s elapsed]
google_vpc_access_connector.connector: Still creating... [1m40s elapsed]
google_sql_database_instance.instance: Still creating... [1m40s elapsed]
google_vpc_access_connector.connector: Still creating... [1m50s elapsed]
google_filestore_instance.instance: Still creating... [1m50s elapsed]
google_sql_database_instance.instance: Still creating... [1m50s elapsed]
google_vpc_access_connector.connector: Creation complete after 1m56s [id=projects/big-bliss-411815/locations/us-central1/connectors/mage-data-prep-connector]
google_filestore_instance.instance: Still creating... [2m0s elapsed]
google_sql_database_instance.instance: Still creating... [2m0s elapsed]
google_filestore_instance.instance: Still creating... [2m10s elapsed]
google_sql_database_instance.instance: Still creating... [2m10s elapsed]
google_filestore_instance.instance: Still creating... [2m20s elapsed]
google_sql_database_instance.instance: Still creating... [2m20s elapsed]
google_filestore_instance.instance: Still creating... [2m30s elapsed]
google_sql_database_instance.instance: Still creating... [2m30s elapsed]
google_filestore_instance.instance: Still creating... [2m40s elapsed]
google_sql_database_instance.instance: Still creating... [2m40s elapsed]
google_filestore_instance.instance: Still creating... [2m50s elapsed]
google_sql_database_instance.instance: Still creating... [2m50s elapsed]
google_filestore_instance.instance: Still creating... [3m0s elapsed]
google_sql_database_instance.instance: Still creating... [3m0s elapsed]
google_filestore_instance.instance: Still creating... [3m10s elapsed]
google_sql_database_instance.instance: Still creating... [3m10s elapsed]
google_filestore_instance.instance: Still creating... [3m20s elapsed]
google_sql_database_instance.instance: Still creating... [3m20s elapsed]
google_filestore_instance.instance: Still creating... [3m30s elapsed]
google_sql_database_instance.instance: Still creating... [3m30s elapsed]
google_filestore_instance.instance: Still creating... [3m40s elapsed]
google_sql_database_instance.instance: Still creating... [3m40s elapsed]
google_filestore_instance.instance: Still creating... [3m50s elapsed]
google_sql_database_instance.instance: Still creating... [3m50s elapsed]
google_filestore_instance.instance: Creation complete after 4m0s [id=projects/big-bliss-411815/locations/us-central1-b/instances/mage-data-prep]
google_sql_database_instance.instance: Still creating... [4m0s elapsed]
google_sql_database_instance.instance: Still creating... [4m10s elapsed]
google_sql_database_instance.instance: Still creating... [4m20s elapsed]
google_sql_database_instance.instance: Still creating... [4m30s elapsed]
google_sql_database_instance.instance: Still creating... [4m40s elapsed]
google_sql_database_instance.instance: Still creating... [4m50s elapsed]
google_sql_database_instance.instance: Still creating... [5m0s elapsed]
google_sql_database_instance.instance: Still creating... [5m10s elapsed]
google_sql_database_instance.instance: Still creating... [5m20s elapsed]
google_sql_database_instance.instance: Still creating... [5m30s elapsed]
google_sql_database_instance.instance: Still creating... [5m40s elapsed]
google_sql_database_instance.instance: Still creating... [5m50s elapsed]
google_sql_database_instance.instance: Still creating... [6m0s elapsed]
google_sql_database_instance.instance: Still creating... [6m10s elapsed]
google_sql_database_instance.instance: Still creating... [6m20s elapsed]
google_sql_database_instance.instance: Still creating... [6m30s elapsed]
google_sql_database_instance.instance: Still creating... [6m40s elapsed]
google_sql_database_instance.instance: Still creating... [6m50s elapsed]
google_sql_database_instance.instance: Still creating... [7m0s elapsed]
google_sql_database_instance.instance: Still creating... [7m10s elapsed]
google_sql_database_instance.instance: Still creating... [7m20s elapsed]
google_sql_database_instance.instance: Still creating... [7m30s elapsed]
google_sql_database_instance.instance: Still creating... [7m40s elapsed]
google_sql_database_instance.instance: Still creating... [7m50s elapsed]
google_sql_database_instance.instance: Still creating... [8m0s elapsed]
google_sql_database_instance.instance: Still creating... [8m10s elapsed]
google_sql_database_instance.instance: Still creating... [8m20s elapsed]
google_sql_database_instance.instance: Still creating... [8m30s elapsed]
google_sql_database_instance.instance: Still creating... [8m40s elapsed]
google_sql_database_instance.instance: Still creating... [8m50s elapsed]
google_sql_database_instance.instance: Still creating... [9m0s elapsed]
google_sql_database_instance.instance: Creation complete after 9m1s [id=mage-data-prep-db-instance]
google_sql_database.database: Creating...
google_sql_user.database-user: Creating...
google_cloud_run_service.run_service: Creating...
google_sql_user.database-user: Creation complete after 3s [id=postgres//mage-data-prep-db-instance]
google_sql_database.database: Creation complete after 10s [id=projects/big-bliss-411815/instances/mage-data-prep-db-instance/databases/mage-data-prep-db]
google_cloud_run_service.run_service: Still creating... [10s elapsed]
google_cloud_run_service.run_service: Still creating... [20s elapsed]
google_cloud_run_service.run_service: Still creating... [30s elapsed]
google_cloud_run_service.run_service: Still creating... [40s elapsed]
google_cloud_run_service.run_service: Still creating... [50s elapsed]
google_cloud_run_service.run_service: Still creating... [1m0s elapsed]
google_cloud_run_service.run_service: Still creating... [1m10s elapsed]
google_cloud_run_service.run_service: Still creating... [1m20s elapsed]
google_cloud_run_service.run_service: Still creating... [1m30s elapsed]
google_cloud_run_service.run_service: Still creating... [1m40s elapsed]
google_cloud_run_service.run_service: Still creating... [1m50s elapsed]
google_cloud_run_service.run_service: Creation complete after 1m53s [id=locations/us-central1/namespaces/big-bliss-411815/services/mage-data-prep]
google_cloud_run_service_iam_member.run_all_users: Creating...
google_cloud_run_service_iam_member.run_all_users: Creation complete after 5s [id=v1/projects/big-bliss-411815/locations/us-central1/services/mage-data-prep/roles/run.invoker/allUsers]

Apply complete! Resources: 14 added, 0 changed, 0 destroyed.


gcloud run services list --region=europe-central2
   SERVICE         REGION           URL                                             LAST DEPLOYED BY                                        LAST DEPLOYED AT
✔  mage-data-prep  europe-central2  https://mage-data-prep-gdriq56qka-lm.a.run.app  mage-zoomcamp@big-bliss-411815.iam.gserviceaccount.com  2024-02-03T21:06:06.817971Z


gcloud sql connect mage-data-prep-db-instance --user=postgres --quiet